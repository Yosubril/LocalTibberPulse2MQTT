FROM python:3.9-slim

WORKDIR /app

# Install dependencies
RUN apt-get update && apt-get install -y curl
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .

# Environment variables with defaults
ENV HTTP_URL="http://192.168.1.7/data.json?node_id=1"
ENV HTTP_USER="admin"
ENV HTTP_PASS="ABCD-A123"
ENV MQTT_HOST="mqtt.example.com"
ENV MQTT_PORT=1883
ENV MQTT_USER="user"
ENV MQTT_PASS="pass"
ENV BASE_TOPIC="sml_meter"
ENV POLL_INTERVAL=10
ENV HEALTHCHECK_PORT=8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:${HEALTHCHECK_PORT}/health || exit 1

CMD ["python", "app.py"]
